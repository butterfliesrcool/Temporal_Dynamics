---
title: "Analyses_I've_Tried"
author: "Abby Robinson"
date: "1/7/2023"
output: html_document
---


##Packages 
```{r}
library(curl)
library(ggplot2)
library(lme4)
library(mvtnorm)
library(lattice)
library(multcomp)
library(emmeans)
library(ggpubr)
remove.packages("MASS")
```

```{r}
d <- curl("https://raw.githubusercontent.com/butterfliesrcool/Quabbin_Data/main/Quabbin_Model_Count_Data.csv")
data <- read.csv(d, header = TRUE, sep = ",")
head(data)
```

```{r}
class(data$day) #integer...
data$day <- as.factor(data$day)
class(data$day)
```

Summary of total attaks on Battus and Junonia (control) during model trials 
```{r}
modeldays <- aggregate(x= data$attacks, by= list(data$day, data$species), FUN=sum)
modeldays
```



```{r}
bat <- subset(data, species == "model_battus", drop = FALSE) 
jun1 <- subset(data, species == "model_junonia", drop = FALSE) 
```

```{r}
###effect of day on attack rates for model battus 
m3 <- glmer(attacks ~ day + (1|site), data =  bat, family = poisson)
summary(m3)
emmeans(m3, pairwise ~ day)
```

```{r}
###effects of day on attack rates for model junonia (control)
m4 <- glmer(attacks ~ day + (1|site), data = jun1, family = poisson)
emmeans(m4, pairwise ~ day)
```

## Trouble-shooting assumptions tests 

Packages 
```{r}
library(curl)
library(lme4)
library(car)
require(MASS)
library(ggplot2)
library(mlmRev)
library(agridat)
library(MCMCglmm)
library(pscl)
```

```{r}
d <- curl("https://raw.githubusercontent.com/butterfliesrcool/Quabbin_Data/main/Quabbin_Count_Data.csv")
data <- read.csv(d, header = TRUE, sep = ",")
head(data)
```

```{r}
hist(data$attacks) ## Based on histrogram of bird attacks, data appears to be zero-inflated 
```
```{r}
library(fitdistrplus)
plotdist(data$attacks, histo = TRUE, demp = TRUE)
```

```{r}
  var(data$attacks)
  mean(data$attacks)
##variance is greater than mean, which indicated that data are overdispersed. 
##run check_overdispersion(x, ...) on the model to check for overdispersion 
```

NOTES: 
The negative binomial distribution is similar to the Poisson except it has an additional parameter called a scale parameter. The scale parameter (ðœ¹) allows the variance to be larger (or smaller) than the mean and may reduce or remedy the over-dispersion problem. Some argue that the negative binomial should always be used for agricultural data while others disagree. 

###In statistics, a zero-inflated model is a statistical model based on a zero-inflated probability distribution, i.e. a distribution that allows for frequent zero-valued observations.

Zero-inflated negative binomial regression is for modeling count variables with excessive zeros and it is usually for over-dispersed count outcome variables. Furthermore, theory suggests that the excess zeros are generated by a separate process from the count values and that the excess zeros can be modeled independently.

```{r}
nbinom <- fitdist(data$attacks, "nbinom")
plot(nbinom)

poisson <- fitdist(data$attacks, "pois")
plot(poisson)

exp <- fitdist(data$attacks, "exp")
plot(exp)
```

```{r}
nbinom.f<- fitdist(data$attacks, "nbinom") # Negative Binomial 
pois.f<- fitdist(data$attacks, "pois") # Poisson
norm.f<- fitdist(data$attacks, "norm") # Normal 
exp.f<- fitdist(data$attacks, "exp") # Exponential 
```

```{r}
summary(nbinom.f)
summary(pois.f)
summary(norm.f)
summary(exp.f)
```

```{r}
par(mfrow = c(2, 2))
plot.legend <- c("Binomial neg", "Poisson")
denscomp(list(nbinom.f,pois.f), legendtext = plot.legend)
qqcomp(list(nbinom.f,pois.f), legendtext = plot.legend)

cdfcomp(list(nbinom.f,pois.f), legendtext = plot.legend)
ppcomp(list(nbinom.f,pois.f), legendtext = plot.legend)
```
```{r}
library(remotes)
library(NBZIMM) ##Negative Binomial Zero Inflated Generalized Linear Mixed Model 
library(nlme)
```

```{r}
f = glmm.zinb(fixed = attacks ~ species + trial + day + time.delay , 
              random = ~ 1 | site, data = data, zi_fixed = ~1) 
summary(f)
summary(f$zi.fit)
```
```{r}
model <- subset(data, trial == "model", drop = FALSE)
hist(model$attacks)
```

```{r}
library(glmmTMB) # compared with glmmTMB
library(performance)

m1 <- glmer(attacks ~ species*day + (1|site), data =  model, family = poisson)
summary(m1)
emmeans(m1, pairwise ~ species*day) 

f0 = glmmTMB(attacks ~ species*day + (1 | site), data = model, 
            family = nbinom2, zi = ~ 1)
summary(f0)
check_overdispersion(f0) #no overdispersion detected 
```



### try glmer.nb() function: https://search.r-project.org/CRAN/refmans/lme4/html/glmer.nb.html
#### From Documentation: subset: an optional expression indicating the subset of the rows of data that should be used in the fit. This can be a logical vector, or a numeric vector indicating which observation numbers are to be included, or a character vector of the row names to be included. All observations are included by default.

##Data needs to be broken down by day for the learning check analysis but it doesn't for everything else 

##writing out data for each individual day can artificially cause increased zero inflation 

## Not accounting for overdispersion can lead to artificially small p values 

Attempts at model building 



```{r} 
# glmms with binomial distribution 
m5 <- glmer.nb(attacks ~ experiment.day + time.delay + (1|site) + (1|time.delay/field.day), data = Battus, verbose=FALSE)
summary(m5)
m6 <- glmer.nb(attacks ~ experiment.day + (1|site) + (1|experiment.day:field.day), data = Battus, verbose=FALSE)
m7 <- glmer.nb(attacks ~ experiment.day*time.delay + (1|site) + (1|field.day), data = Battus, verbose=FALSE)
m8 <- glmer.nb(attacks ~ experiment.day*time.delay + (1|site) + (1|experiment.day:field.day), data = Battus, verbose=FALSE)

anova(m5, m6, m7, m8)
anova(m1, m5) 

# no significant differences between the poisson and negative binomial models 
```

```{r}
m5simulation <- simulateResiduals(fittedModel = m5, plot = T)

testUniformity(m5simulation) 
testOutliers(m5simulation)
testDispersion(m5simulation)
testZeroInflation(m5simulation)

# SUMMARY: the poisson model has a lower AIC score than the binomial model. With the poisson model, I get a significant deviation in the KS test, which suggests that data are not uniform with respect to the specified distribution. To correct for this, I fitted another model with a negative binomial distribution, this model had a slightly larger AIC score, but corrected for the significant deviation in the KS test. Given that, which model should I use???? 
```


#### Model output & pairwise tukey test

```{r}
summary(m1)
emmeans(m1, pairwise ~ experiment.day) ### pairwise analysis to look at patterns of significance between specific days 
```

```{r}
summary(m5)
emmeans(m5, pairwise ~ experiment.day) 
```

### **JUNONIA: MODEL TRIAL**

#### Model fitting, Assumptions & Residuals Check 

```{r}
# histogram of attacks on junonia in model trial 
hist(Junonia$attacks) # concerns about zero inflation based on histogram 

# check variance and mean to assess for over / under - dispersion 
var(Junonia$attacks)
mean(Junonia$attacks) # variance is greater than mean, which indicates that over dispersion might be an issue 

# fit poisson and negative binomial glmms and use the anova() function to test for model fit 
j.m1 <- glmer(attacks ~ experiment.day + (1|site) + (1|field.day), data =  Junonia, family = poisson)
j.m2 <- glmer(attacks ~ experiment.day + (1|site) + (1|experiment.day:field.day), data =  Junonia, family = poisson)
j.m3 <- glmer(attacks ~ experiment.day*time.delay + (1|site) + (1|field.day), data =  Junonia, family = poisson)
j.m4 <- glmer(attacks ~ experiment.day*time.delay + (1|site) + (1|experiment.day:field.day), data =  Junonia, family = poisson)
j.m5 <- glmer.nb(attacks ~ experiment.day + (1|site) + (1|field.day), data = Junonia, verbose=FALSE)
j.m6 <- glmer.nb(attacks ~ experiment.day + (1|site) + (1|experiment.day:field.day), data = Junonia, verbose=FALSE)
j.m7 <- glmer.nb(attacks ~ experiment.day*time.delay + (1|site) + (1|field.day), data = Junonia, verbose=FALSE)
j.m8 <- glmer.nb(attacks ~ experiment.day*time.delay + (1|site) + (1|experiment.day:field.day), data = Junonia, verbose=FALSE)

anova(j.m1, j.m2, j.m3, j.m4) 
anova(j.m5, j.m6, j.m7, j.m8) 
anova(j.m1, j.m5) 

# no significant difference in model fit 
```

```{r}
# assumptions and residual checks for poisson model with best fit 

j.m1simulation <- simulateResiduals(fittedModel = j.m1, plot = T)

testUniformity(j.m1simulation)
testOutliers(j.m1simulation)
testDispersion(j.m1simulation) 
testZeroInflation(j.m1simulation) 
```

```{r}
# assumptions and residual checks for negative binomial model with best fit 

j.m5simulation <- simulateResiduals(fittedModel = j.m5, plot = T)

testUniformity(j.m5simulation) 
testOutliers(j.m5simulation)
testDispersion(j.m5simulation) 
testZeroInflation(j.m5simulation) 
```

#### Model output & pairwise tukey test

```{r}
summary(j.m1)
emmeans(j.m1, pairwise ~ experiment.day) ### pairwise analysis to look at patterns of significance related to day 1, specifically 
```

```{r}
summary(j.m5)
emmeans(j.m5, pairwise ~ experiment.day) 
```

Install these packages in R: {curl}, {ggplot2}, {lme4}, {AICcmodavg}, {MuMIn}

```{r}
library(curl)
library(ggplot2)
library(lme4)
library(AICcmodavg)
```

Generalized linear mixed models (GLMM), if weâ€™re dealing with various other variable types and error structure (e.g., binary, proportion, or count data).

```{r}
d <- curl("https://raw.githubusercontent.com/butterfliesrcool/Quabbin_Data/main/binomial_quabbin_data_all.csv")
data <- read.csv(d, header = TRUE, sep = ",")
head(data)
```

GLMM for all data - but we don't want to compare all the data... do we? 

Too much information here... 
```{r}
m <- glmer(attacks ~ species + trial + time.delay + day + (1|site), data = data, family = binomial)
summary(m, corr = FALSE)
###"day" is the only strong predictor of patterns in the data
###ALSO no significant difference in attack rates between the time delayed trials: four, two, one
#######How can I show this more explicitly? do I need to? 
```

```{r}
m <- glmer(attacks ~ trial*species*day + (1|site), data = data, family = binomial)
```


We start by just comparing the three trials with temporal delays in exposure to models and mimics. We can't directly compare these trials to the simultaneous trial because we do not have comparable sample sizes 
```{r}
temp.delay <- subset(data, trial %in% c("model", "mimic"), drop = FALSE)
class(temp.delay$day) #integer... boo...
temp.delay$day <- as.factor(temp.delay$day)
class(temp.delay$day)

m <- glmer(attacks ~ trial*species + (1|site), data =  temp.delay, family = binomial)
# Post-hoc analysis
emmeans(m, pairwise ~ trial * species) ###only look at the comparisons that are biologically meaningful??
```

Separate model and mimic trials 
```{r}
models <- subset(temp.delay, trial == "model", drop = FALSE) 
mimics <- subset(temp.delay, trial == "mimic", drop = FALSE)
```

[1] Did birds learn to avoid Battus over 4-day model trials? 
```{r}
library(lsmeans)
library(emmeans)
class(models$day)
m9 <- glmer(attacks ~ species*day + (1|site), data = models, family = binomial)
###how can I get the speciesbattus:day interaction in this result? does this model show that attacks on battus decreased faster over the four days?

emmeans(m9, pairwise ~ species * day) 
```
```{r}
m12 <- glmer(attacks ~ species + day + (1|site), data = mimics, family = binomial)
emmeans(m12, pairwise ~ species * day) ###this isn't working and I don't know why.... 
```

```{r}
battus <- subset(models, species == "battus", drop = FALSE) 
junonia <- subset(models, species == "junonia", drop = FALSE) 
```

```{r}
bat <- glmer(attacks ~ day + (1|site), data = battus, family = binomial)
summary(bat, corr = FALSE)
```

```{r}
jun <- glmer(attacks ~ day + (1|site), data = junonia, family = binomial)
summary(jun, corr = FALSE)
##model does not work 
##Warning in checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv,  :  Model failed to converge with max|grad| = 0.0288983 (tol = 0.002, component 1)
```


```{r}
m12 <- glmer(attacks ~ species + day + (1|site), data = mimics, family = binomial)
summary(m12, corr = FALSE)
```


-------------------------------------------------------------------------------------------------------
Extra Code: 

```{r}
m0 <- glmer(attacks ~ species + trial + time.delay + (1|site), data = data, family = binomial)
summary(m0, corr = FALSE)
##no patterns?
```

```{r}
m1 <- glmer(attacks ~ species*time.delay + (1|site), data = data, family = binomial)
summary(m1, corr = FALSE)
##no differences in attack rates between time time delayed trials 
```

```{r}
m0.5 <- glmer(attacks ~ species*day + (1|site), data = data, family = binomial)
summary(m0.5)

### "fixed-effect model matrix is rank deficient so dropping 8 columns / coefficients" what??? 
```

GLMMs for Time Delayed Trials (remove simultaneous experiment from this analysis)
###Models with all experimental days included 


```{r}
m2 <- glmer(attacks ~ species + trial + time.delay + day + (1|site), data =  temp.delay, family = binomial)
summary(m2, corr = FALSE)
####significant difference in attack rates between the model and mimic trials for the time-delayed experiments 
####"day" is highly significant predictor of patterns in the data 
```

```{r}
m3 <- glmer(attacks ~ species*trial + time.delay + day + (1|site), data =  temp.delay, family = binomial)
summary(m3, corr = FALSE) 
```

```{r}
m4 <- glmer(attacks ~ species*day + time.delay + (1|site), data =  temp.delay, family = binomial)
summary(m4, corr = FALSE) 
###Day explains attack rates on different species? 
```

```{r}
m5 <- glmer(attacks ~ species*day + (1|site), data =  temp.delay, family = binomial)
summary(m5, corr = FALSE) 
```

```{r}
m6 <- glmer(attacks ~ species*time.delay + (1|site), data =  temp.delay, family = binomial)
summary(m6, corr = FALSE) 
###no significant differences in attacks between time delayed trials?
```

###Models with only post-learning days (pld) to focus in on patterns of attack on days after birds have learned model unpalatability 
```{r}
pld <- subset(temp.delay, day %in% c("2", "3", "4"), drop = FALSE)
```

```{r}
m7 <- glmer(attacks ~ species + trial + time.delay + day + (1|site), data = pld, family = binomial)
summary(m7, corr = FALSE)
###"day" is no longer significant 
```

```{r}
m8 <- glmer(attacks ~ trial*species + (1|site), data = pld, family = binomial)
  ##interaction between species and trial for post learning days
  ##removed time.delay... doesn't explain patterns in the data?? 
  ##reach out to data people at BU to help interpret these results 
  ##significant differences in attack rates between model and mimic trials 
```

```{r}
m10 <- glmer(attacks ~ species + time.delay + day + (1|site), data = models, family = binomial)
summary(m10, corr = FALSE)

models.pld <- subset(pld, trial == "model", drop = FALSE)
mimics.pld <- subset(pld, trial == "mimic", drop = FALSE)

m11 <- glmer(attacks ~ species + day + (1|site), data = models.pld, family = binomial)
summary(m11, corr = FALSE) ##Significant difference in attack rates between battus and junonia, no impact of day 

m13 <- glmer(attacks ~ species + time.delay + day + (1|site), data = mimics, family = binomial)
summary(m13, corr = FALSE) ###weird warning message here... 


m14 <- glmer(attacks ~ species + day + (1|site), data = mimics.pld, family = binomial)
summary(m14, corr = FALSE) ###no significant difference in attack rates between junonia and limenitis, and no significant difference in attacks on days 2-4
```



Summary of Findings: 
- no significant differences between time delayed trials in any of the models 
- day is the main predictor of patterns in the data, with no significant diferences between species when looking at all experimental days. the effects of day go away when looking at days 2-4, and significant patterns between species emerge 

GLMMs for Simultaneous Trials 
```{r}
sim <- subset(data, trial == "simultaneously", drop = FALSE)
head(sim)
m <- glmer(attacks ~ species + (1|site/fac.no), data =  sim, family = binomial)
# Post-hoc analysis
emmeans(m, pairwise ~ species)

m15 <- glmer(attacks ~ species + day + (1|site), data = sim, family = binomial)
summary(m15, corr = FALSE) ###Junonia is close to being significant... 

m16 <- glmer(attacks ~ species + (1|site), data = sim, family = binomial)
summary(m16, corr = FALSE)
##not significant, likely because of low sample sizes... is there a correction I can use? 
```

```{r}
four_weeks <- subset(data, time.delay == "four", drop = FALSE) 
two_weeks <- subset(data, time.delay == "two", drop = FALSE) 
one_week <- subset(data, time.delay == "one", drop = FALSE) 
sim <- subset(data, trial == "simultaneously", drop = FALSE)
```

Proportionals analysis on attacks on limenitis relative to total attacks for time-delayed trials: four, two, one, and zero 

```{r}
four <- prop.test(x = c(11, 7), n = c(18, 18))
# Printing the results
four
```

```{r}
m2 <- glmer(attacks ~ species + (1|site/fac.no), data =  sim, family = binomial)
emmeans(m2, pairwise ~ species)
```

```{r}
two <- prop.test(x = c(10, 6), n = c(16, 16))
# Printing the results
two
```

```{r}
one <- prop.test(x = c(7, 7), n = c(14, 14))
# Printing the results
one
```

```{r}
zero <- prop.test(x = c(4, 15), n = c(19, 19))
# Printing the results
zero
```


Sources: 
# https://data.library.virginia.edu/getting-started-with-binomial-generalized-linear-mixed-models/



[5] Attack rates on limenitis and junonia for time delayed treatments: four, two, one, & zero
```{r}
##Evidence of protection for the mimic 
d <- subset(data, trial %in% c("mimic", "simultaneously"), drop = FALSE)
mimic.phases <- subset(d, species %in% c("limenitis", "junonia"), drop = FALSE)

attacks.by.treatment <- aggregate(x= mimic.phases$attacks, by= list(mimic.phases$species, mimic.phases$time.delay), FUN=sum)
attacks.by.treatment

percent <- (attacks.by.treatment$x/500)*100 ## 500 facsimiles in each time-delay treatment 
attacks.by.treatment$percent <- percent
attacks.by.treatment
```

```{r}
df <- data.frame(
  gap.in.weeks = c("four", "two", "one", "zero"),
  l = c(2.2, 2.0, 1.4, 0.8),
  j = c(1.4, 1.2, 1.4, 3.0)
)
mimic <- t(cbind(df$l, df$j))
barplot(mimic, beside=T, names.arg = df$gap.in.weeks, col=c("black","grey"),ylim= c(0,3), cex.axis=2)
```

```{r}
four_weeks <- subset(mimics, time.delay == "four", drop = FALSE) 
two_weeks <- subset(mimics, time.delay == "two", drop = FALSE) 
one_week <- subset(mimics, time.delay == "one", drop = FALSE) 
sim <- subset(data, trial == "simultaneously", drop = FALSE)

zero_gap <- subset(sim, species %in% c("sim_limenitis", "sim_junonia"), drop = FALSE)
```


```{r}
four <- aggregate(x= four_weeks$attacks, by= list(four_weeks$species), FUN=sum)
percent <- (four$x/500)*100 ## 500 facsimiles in each time-delay treatment 
four$percent <- percent
four

four.fig <- ggplot(four, aes(x=Group.1, y=percent)) +  geom_bar(stat = "identity") + ylim(0,3)
four.fig <- four.fig + xlab("Species") + ylab("Attack Rate")
four.fig <- four.fig + scale_x_discrete(limits =  c("mimic_limenitis", "mimic_junonia"), labels = c("mimic_limenitis" = "Limenitis arthemis (mimic)","mimic_junonia" = "Junonia coenia (control)") )
four.fig
```

```{r}
two <- aggregate(x= two_weeks$attacks, by= list(two_weeks$species), FUN=sum)
percent <- (two$x/500)*100 ## 500 facsimiles in each time-delay treatment 
two$percent <- percent
two

two.fig <- ggplot(two, aes(x=Group.1, y=percent)) +  geom_bar(stat = "identity") + ylim(0,3)
two.fig <- two.fig + xlab("Species") + ylab("Attack Rate")
two.fig <- two.fig + scale_x_discrete(limits =  c("mimic_limenitis", "mimic_junonia"), labels = c("mimic_limenitis" = "Limenitis arthemis (mimic)","mimic_junonia" = "Junonia coenia (control)") )
two.fig
```

```{r}
one <- aggregate(x= one_week$attacks, by= list(one_week$species), FUN=sum)
percent <- (one$x/500)*100 ## 500 facsimiles in each time-delay treatment 
one$percent <- percent
one

one.fig <- ggplot(one, aes(x=Group.1, y=percent)) +  geom_bar(stat = "identity") + ylim(0,3)
one.fig <- one.fig + xlab("Species") + ylab("Attack Rate")
one.fig <- one.fig + scale_x_discrete(limits =  c("mimic_limenitis", "mimic_junonia"), labels = c("mimic_limenitis" = "Limenitis arthemis (mimic)","mimic_junonia" = "Junonia coenia (control)") )
one.fig
```

```{r}
zero <- aggregate(x= zero_gap$attacks, by= list(zero_gap$species), FUN=sum)
percent <- (zero$x/500)*100 ## 500 facsimiles in each time-delay treatment 
zero$percent <- percent
zero

zero.fig <- ggplot(zero, aes(x=Group.1, y=percent)) +  geom_bar(stat = "identity") + ylim(0,3)
zero.fig <- zero.fig + xlab("Species") + ylab("Attack Rate")
zero.fig <- zero.fig + scale_x_discrete(limits =  c("sim_limenitis", "sim_junonia"), labels = c("sim_limenitis" = "Limenitis arthemis (mimic)","simjunonia" = "Junonia coenia (control)") )
zero.fig
```

```{r}
figure <- ggarrange(four.fig, two.fig, one.fig, zero.fig,
                    labels = c("A", "B", "C", "D"),
                    ncol = 2, nrow = 2)
figure
```


